<%- include('../layouts/header', { title: title }) %>
<%- include('../partials/navbar') %>

<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-lg-6">
      <div class="card bg-dark text-white">
        <div class="card-header bg-gradient text-center">
          <h3><i class="fas fa-info-circle"></i> Payment Status</h3>
        </div>
        <div class="card-body text-center">
          <!-- TIMER - Tampil untuk status waiting/pending -->
          <div id="timer-section" class="<%= ['pending', 'waiting'].includes(transaction.status) ? '' : 'd-none' %>">
            <div class="p-3 mb-4 bg-warning bg-opacity-10 border border-warning rounded">
              <h6><i class="fas fa-clock"></i> Payment expires in:</h6>
              <h3 id="countdown-timer" class="mb-0" data-expired="<%= new Date(transaction.expired_at).toISOString() %>">Loading...</h3>
            </div>
          </div>
          
          <!-- Status Icon - Update via JavaScript -->
          <div id="status-icon" class="status-icon mb-4">
            <% if (transaction.status === 'success') { %>
              <i class="fas fa-check-circle fa-5x text-success"></i>
              <h3 class="text-success mt-3">Payment Successful!</h3>
              <p>Your purchase is complete. Check your email for details.</p>
            <% } else if (transaction.status === 'waiting' || transaction.status === 'pending') { %>
              <i class="fas fa-clock fa-5x text-warning"></i>
              <h3 class="text-warning mt-3">Waiting for Payment</h3>
              <p>Please complete your payment to continue.</p>
            <% } else if (transaction.status === 'processing') { %>
              <i class="fas fa-spinner fa-spin fa-5x text-info"></i>
              <h3 class="text-info mt-3">Processing Payment</h3>
              <p>Verifying your payment. Please wait...</p>
            <% } else if (transaction.status === 'failed') { %>
              <i class="fas fa-times-circle fa-5x text-danger"></i>
              <h3 class="text-danger mt-3">Payment Failed</h3>
              <p>Something went wrong. Please try again.</p>
            <% } else if (transaction.status === 'expired') { %>
              <i class="fas fa-hourglass-end fa-5x text-secondary"></i>
              <h3 class="text-secondary mt-3">Payment Expired</h3>
              <p>Your payment link has expired. Please create a new order.</p>
            <% } %>
          </div>
          
          <!-- Order Info -->
          <div class="order-info mb-4">
            <p class="mb-1"><strong>Order ID:</strong> <%= transaction.order_id %></p>
            <p class="mb-1"><strong>Game:</strong> <%= transaction.game_title %></p>
            <p class="mb-0"><strong>Amount:</strong> Rp <%= transaction.amount.toLocaleString('id-ID') %></p>
          </div>
          
          <!-- Actions -->
          <div id="action-buttons" class="d-grid gap-2">
            <% if (transaction.status === 'success') { %>
              <a href="/games/<%= transaction.game_slug %>" class="btn btn-success btn-lg">
                <i class="fas fa-play"></i> Play Game Now
              </a>
            <% } else if (transaction.status === 'waiting' || transaction.status === 'pending' || transaction.status === 'processing') { %>
              <button id="check-status-btn" class="btn btn-aqua btn-lg">
                <i class="fas fa-sync"></i> Refresh Status
              </button>
              <a href="/payment/<%= transaction.order_id %>/invoice" class="btn btn-outline-secondary">
                <i class="fas fa-receipt"></i> View Invoice
              </a>
            <% } else { %>
              <a href="/games/<%= transaction.game_slug %>" class="btn btn-primary">
                Try Again
              </a>
            <% } %>
            
            <a href="/" class="btn btn-outline-secondary">
              <i class="fas fa-home"></i> Back to Home
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Global variables
let timerInterval = null;
let checkInterval = null;
const gameSlug = '<%= transaction.game_slug %>';
const orderId = '<%= transaction.order_id %>';

console.log('=== PAGE LOADED ===');
console.log('Initial status:', '<%= transaction.status %>');

// Countdown Timer Function
function updateTimer() {
  const timerEl = document.getElementById('countdown-timer');
  if (!timerEl) return;
  
  const expiredAt = new Date(timerEl.dataset.expired).getTime();
  const now = new Date().getTime();
  const distance = expiredAt - now;
  
  if (distance < 0) {
    timerEl.innerHTML = 'EXPIRED';
    timerEl.classList.add('text-danger');
    if (timerInterval) {
      clearInterval(timerInterval);
      console.log('Timer stopped - EXPIRED');
    }
    return;
  }
  
  const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
  const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
  const seconds = Math.floor((distance % (1000 * 60)) / 1000);
  
  timerEl.innerHTML = 
    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}

// Update UI based on status WITHOUT reloading page
function updateStatusUI(status) {
  console.log('Updating UI to status:', status);
  
  const statusIcon = document.getElementById('status-icon');
  const actionButtons = document.getElementById('action-buttons');
  const timerSection = document.getElementById('timer-section');
  
  if (status === 'success') {
    // Stop all intervals
    if (timerInterval) {
      clearInterval(timerInterval);
      console.log('Timer interval cleared');
    }
    if (checkInterval) {
      clearInterval(checkInterval);
      console.log('Check interval cleared');
    }
    
    // Hide timer
    if (timerSection) {
      timerSection.classList.add('d-none');
      console.log('Timer section hidden');
    }
    
    // Update status icon
    statusIcon.innerHTML = `
      <i class="fas fa-check-circle fa-5x text-success"></i>
      <h3 class="text-success mt-3">Payment Successful!</h3>
      <p>Your purchase is complete. Check your email for details.</p>
    `;
    
    // Update action buttons
    actionButtons.innerHTML = `
      <a href="/games/${gameSlug}" class="btn btn-success btn-lg">
        <i class="fas fa-play"></i> Play Game Now
      </a>
      <a href="/" class="btn btn-outline-secondary">
        <i class="fas fa-home"></i> Back to Home
      </a>
    `;
    
    console.log('UI updated to SUCCESS');
  } else if (status === 'failed') {
    if (timerInterval) clearInterval(timerInterval);
    if (checkInterval) clearInterval(checkInterval);
    if (timerSection) timerSection.classList.add('d-none');
    
    statusIcon.innerHTML = `
      <i class="fas fa-times-circle fa-5x text-danger"></i>
      <h3 class="text-danger mt-3">Payment Failed</h3>
      <p>Something went wrong. Please try again.</p>
    `;
    
    actionButtons.innerHTML = `
      <a href="/games/${gameSlug}" class="btn btn-primary">
        Try Again
      </a>
      <a href="/" class="btn btn-outline-secondary">
        <i class="fas fa-home"></i> Back to Home
      </a>
    `;
    
    console.log('UI updated to FAILED');
  } else if (status === 'expired') {
    if (timerInterval) clearInterval(timerInterval);
    if (checkInterval) clearInterval(checkInterval);
    if (timerSection) timerSection.classList.add('d-none');
    
    statusIcon.innerHTML = `
      <i class="fas fa-hourglass-end fa-5x text-secondary"></i>
      <h3 class="text-secondary mt-3">Payment Expired</h3>
      <p>Your payment link has expired. Please create a new order.</p>
    `;
    
    actionButtons.innerHTML = `
      <a href="/games/${gameSlug}" class="btn btn-primary">
        Try Again
      </a>
      <a href="/" class="btn btn-outline-secondary">
        <i class="fas fa-home"></i> Back to Home
      </a>
    `;
    
    console.log('UI updated to EXPIRED');
  } else if (status === 'processing') {
    statusIcon.innerHTML = `
      <i class="fas fa-spinner fa-spin fa-5x text-info"></i>
      <h3 class="text-info mt-3">Processing Payment</h3>
      <p>Verifying your payment. Please wait...</p>
    `;
    console.log('UI updated to PROCESSING');
  } else if (['waiting', 'pending'].includes(status)) {
    // Ensure timer is visible
    if (timerSection) {
        timerSection.classList.remove('d-none');
        console.log('Timer section shown (pending/waiting)');
    }
    statusIcon.innerHTML = `
      <i class="fas fa-clock fa-5x text-warning"></i>
      <h3 class="text-warning mt-3">Waiting for Payment</h3>
      <p>Please complete your payment to continue.</p>
    `;
    console.log('UI updated to PENDING/WAITING');
  }
}

// Check payment status via AJAX (NO page reload)
async function checkPaymentStatus() {
  try {
    console.log('Checking payment status...');
    const response = await fetch(`/payment/${orderId}/check`);
    const data = await response.json();
    
    console.log('Status check result:', data.status);
    
    // PENTING: Hanya update UI, JANGAN reload!
    if (data.status !== '<%= transaction.status %>') {
      updateStatusUI(data.status);
    }
  } catch (error) {
    console.error('Failed to check status:', error);
  }
}

// Manual refresh button
const statusBtn = document.getElementById('check-status-btn');
if (statusBtn) {
  statusBtn.addEventListener('click', async function() {
    const originalText = this.innerHTML;
    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
    this.disabled = true;
    
    await checkPaymentStatus();
    
    setTimeout(() => {
      this.innerHTML = originalText;
      this.disabled = false;
    }, 1000);
  });
  console.log('Manual refresh button initialized');
}

// Initialize for pending/waiting status
const transactionStatus = '<%= transaction.status %>';
console.log('Transaction status:', transactionStatus);

if (['waiting', 'pending', 'processing'].includes(transactionStatus)) {
  // Start countdown timer
  console.log('Starting timer...');
  updateTimer();
  timerInterval = setInterval(function() {
    updateTimer();
  }, 1000);
  
  // Auto check status every 5 seconds WITHOUT reloading page
  console.log('Starting auto-check (every 5 seconds)...');
  checkInterval = setInterval(function() {
    checkPaymentStatus();
  }, 5000);
  
  console.log('=== TIMER AND AUTO-CHECK STARTED ===');
  console.log('Timer interval ID:', timerInterval);
  console.log('Check interval ID:', checkInterval);
} else {
  console.log('Status is not pending/waiting, timer not started');
}
</script>

<%- include('../layouts/footer') %>