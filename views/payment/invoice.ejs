<%- include('../layouts/header', { title: title }) %>
<%- include('../partials/navbar') %>

<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card bg-dark text-white">
        <div class="card-header bg-gradient text-center">
          <h3><i class="fas fa-receipt"></i> Payment Invoice</h3>
        </div>
        <div class="card-body">
          <!-- Timer -->
          <% if (transaction.status === 'pending' || transaction.status === 'waiting') { %>
          <div class="p-3 mb-4 bg-warning bg-opacity-10 border border-warning rounded text-center">
            <h5><i class="fas fa-clock"></i> Payment expires in:</h5>
            <h2 id="countdown-timer" class="mb-0" data-expired="<%= new Date(transaction.expired_at).toISOString() %>">Loading...</h2>
          </div>
          <% } %>
          
          <!-- Order Details -->
          <div class="invoice-details">
            <h5 class="border-bottom pb-2 mb-3">Order Details</h5>
            <table class="table table-dark table-borderless">
              <tr>
                <td><strong>Order ID:</strong></td>
                <td><%= transaction.order_id %></td>
              </tr>
              <tr>
                <td><strong>Game:</strong></td>
                <td><%= transaction.game_title %></td>
              </tr>
              <tr>
                <td><strong>Amount:</strong></td>
                <td class="text-aqua"><strong>Rp <%= transaction.amount.toLocaleString('id-ID') %></strong></td>
              </tr>
              <tr>
                <td><strong>Payment Method:</strong></td>
                <td><%= transaction.payment_method %></td>
              </tr>
              <tr>
                <td><strong>Status:</strong></td>
                <td><span class="badge bg-<%= transaction.status === 'success' ? 'success' : (transaction.status === 'failed' ? 'danger' : 'warning') %>"><%= transaction.status %></span></td>
              </tr>
            </table>
          </div>
          
          <!-- Payment Instructions -->
          <% if (transaction.status === 'pending' || transaction.status === 'waiting') { %>
          <div class="payment-instructions mt-4">
            <h5 class="border-bottom pb-2 mb-3">Payment Instructions</h5>
            
            <% if (transaction.payment_method === 'QRIS') { %>
              <div class="text-center">
                <% if (transaction.payment_url) { %>
                  <!-- Generate QR Code from Payment URL using API -->
                  <img src="https://api.qrserver.com/v1/create-qr-code/?size=250x250&amp;data=<%= encodeURIComponent(transaction.payment_url) %>" 
                       alt="QR Code" 
                       class="img-fluid bg-white p-2 rounded" 
                       style="max-width: 250px;">
                  <p class="mt-3">Scan this QR code or:</p>
                  <a href="<%= transaction.payment_url %>" target="_blank" class="btn btn-outline-primary btn-sm">
                    Open Payment Link
                  </a>
                <% } else { %>
                   <div class="alert alert-warning">
                     QR Code not available. Please try again or check Payment Status.
                   </div>
                <% } %>
              </div>
            <% } else if (transaction.payment_method === 'VIRTUAL_ACCOUNT') { %>
              <div class="alert alert-info">
                <p><strong>Virtual Account Number:</strong></p>
                <h3><%= transaction.payment_code || '-' %></h3>
                <p class="mb-0">Transfer to this VA number from your bank</p>
              </div>
            <% } else if (transaction.payment_method === 'RETAIL') { %>
              <div class="alert alert-info">
                <p><strong>Payment Code:</strong></p>
                <h3><%= transaction.payment_code || '-' %></h3>
                <p class="mb-0">Show this code at cashier</p>
              </div>
            <% } %>
            
            <% if (transaction.payment_url && transaction.payment_method !== 'QRIS') { %>
              <div class="text-center mt-3">
                <a href="<%= transaction.payment_url %>" target="_blank" class="btn btn-primary btn-lg">
                  <i class="fas fa-external-link-alt"></i> Continue to Payment
                </a>
              </div>
            <% } %>
          </div>
          <% } %>
          
          <!-- Actions -->
          <div class="d-grid gap-2 mt-4">
            <a href="/" class="btn btn-outline-secondary">
              <i class="fas fa-home"></i> Back to Home
            </a>
            <a href="/payment/<%= transaction.order_id %>/status" class="btn btn-aqua">
              <i class="fas fa-info-circle"></i> Check Payment Status
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Countdown Timer (24 hours)
const timerEl = document.getElementById('countdown-timer');
const expiredAt = timerEl ? new Date(timerEl.dataset.expired).getTime() : 0;

function updateTimer() {
  const now = new Date().getTime();
  const distance = expiredAt - now;
  
  if (distance < 0) {
    document.getElementById('countdown-timer').innerHTML = 'EXPIRED';
    return;
  }
  
  const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
  const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
  const seconds = Math.floor((distance % (1000 * 60)) / 1000);
  
  const timerElement = document.getElementById('countdown-timer');
  if (timerElement) {
      timerElement.innerHTML = 
        `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
  }
}

</script>

<% if (transaction.status === 'pending' || transaction.status === 'waiting') { %>
<script>
updateTimer();
setInterval(updateTimer, 1000);
</script>
<% } %>

<%- include('../layouts/footer') %>
