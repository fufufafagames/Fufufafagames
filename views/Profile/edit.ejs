<%- include('../layouts/header', { title: title }) %> <%-
include('../partials/navbar') %>

<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-lg-6">
      <div class="form-card">
        <div class="text-center mb-4">
          <% if (profileUser.avatar) { %>
            <img src="<%= profileUser.avatar %>" alt="Profile Avatar" class="rounded-circle mb-3 border border-3 border-aqua" style="width: 120px; height: 120px; object-fit: cover;">
          <% } else { %>
            <div class="rounded-circle bg-secondary d-inline-flex align-items-center justify-content-center mb-3 border border-3 border-aqua" style="width: 120px; height: 120px;">
              <i class="fas fa-user fa-4x text-white"></i>
            </div>
          <% } %>
          <h2 class="mt-2">Edit Profile</h2>
          <p class="text-white">Update your profile information</p>
        </div>

        <form action="/profile/update/me?_method=PUT" method="POST" enctype="multipart/form-data">
          <div class="mb-3">
            <label for="name" class="form-label">
              <i class="fas fa-user"></i> Full Name
            </label>
            <input
              type="text"
              class="form-control"
              id="name"
              name="name"
              value="<%= profileUser.name %>"
              required
            />
          </div>

          <div class="mb-3">
            <label for="email" class="form-label">
              <i class="fas fa-envelope"></i> Email Address
            </label>
            <input
              type="email"
              class="form-control"
              style="background-color: black"
              id="email"
              value="<%= profileUser.email %>"
              disabled
            />
            <small class="text-white">Email cannot be changed</small>
          </div>

          <div class="mb-3">
            <label class="form-label"><i class="fas fa-image"></i> Avatar</label>
            
            <style>
              .nav-tabs .nav-link {
                color: #fff;
                border-color: #444;
              }
              .nav-tabs .nav-link.active {
                background-color: #00ADB5; /* Aqua color */
                color: #fff;
                border-color: #00ADB5;
              }
              .nav-tabs .nav-link:hover {
                border-color: #00ADB5;
                color: #00ADB5;
              }
              .nav-tabs .nav-link.active:hover {
                color: #fff;
              }
            </style>
            <ul class="nav nav-tabs mb-3 border-secondary" id="avatarTab" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" type="button" role="tab">
                  <i class="fas fa-upload me-2"></i> Upload File
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="url-tab" data-bs-toggle="tab" data-bs-target="#url" type="button" role="tab">
                  <i class="fas fa-link me-2"></i> Image URL
                </button>
              </li>
            </ul>
            
            <div class="tab-content" id="avatarTabContent">
              <div class="tab-pane fade show active" id="upload" role="tabpanel">
                <input type="file" class="form-control" name="avatarFile" accept="image/*">
                <small class="text-white">Max 20MB (JPG, PNG, GIF)</small>
              </div>
              <div class="tab-pane fade" id="url" role="tabpanel">
                <input
                  type="url"
                  class="form-control"
                  id="avatar"
                  name="avatar"
                  value="<%= profileUser.avatar || '' %>"
                  placeholder="https://example.com/avatar.jpg"
                />
              </div>
            </div>
          </div>

          <div class="mb-4">
            <label for="bio" class="form-label">
              <i class="fas fa-align-left"></i> Bio
            </label>
            <textarea
              class="form-control"
              id="bio"
              name="bio"
              rows="4"
              maxlength="500"
            >
<%= profileUser.bio || '' %></textarea
            >
            <small class="text-white"
              >Tell us about yourself (max 500 characters)</small
            >
          </div>

          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-aqua btn-lg" id="submitBtn">
              <span id="btnText"><i class="fas fa-save"></i> Save Changes</span>
              <span id="btnSpinner" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
              <span id="btnLoadingText" style="display: none;">Saving...</span>
            </button>
            <a
              href="/profile/<%= profileUser.id %>"
              class="btn btn-outline-aqua"
            >
              <i class="fas fa-times"></i> Cancel
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  // Loading State Logic
  const form = document.querySelector('form');
  const submitBtn = document.getElementById('submitBtn');
  const btnText = document.getElementById('btnText');
  const btnSpinner = document.getElementById('btnSpinner');
  const btnLoadingText = document.getElementById('btnLoadingText');

  if (form) {
    form.addEventListener('submit', function() {
      // Validate HTML5 validity first
      if (this.checkValidity()) {
        submitBtn.disabled = true;
        btnText.style.display = 'none';
        btnSpinner.style.display = 'inline-block';
        btnLoadingText.style.display = 'inline-block';
      }
    });
  }

  // Avatar Preview Logic
  // ... (existing code)
  document.addEventListener('DOMContentLoaded', function() {
    const avatarInput = document.querySelector('input[name="avatarFile"]');
    const avatarUrlInput = document.querySelector('input[name="avatar"]');
    const previewImage = document.querySelector('.text-center img');
    const previewContainer = document.querySelector('.text-center');
    
    // Function to update preview
    const updatePreview = (src) => {
      if (!previewImage) {
        // Create img element if it doesn't exist (e.g. initial state was icon)
        const iconDiv = previewContainer.querySelector('.rounded-circle.bg-secondary');
        if (iconDiv) iconDiv.remove();
        
        const newImg = document.createElement('img');
        newImg.className = 'rounded-circle mb-3 border border-3 border-aqua';
        newImg.style.width = '120px';
        newImg.style.height = '120px';
        newImg.style.objectFit = 'cover';
        newImg.src = src;
        
        const title = previewContainer.querySelector('h2');
        previewContainer.insertBefore(newImg, title);
      } else {
        previewImage.src = src;
      }
    };

    // Handle File Input Change
    if (avatarInput) {
      avatarInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            updatePreview(e.target.result);
          }
          reader.readAsDataURL(file);
        }
      });
    }

    // Handle URL Input Change
    if (avatarUrlInput) {
      avatarUrlInput.addEventListener('input', function(e) {
        if (e.target.value) {
          updatePreview(e.target.value);
        }
      });
    }
  });
</script>

<%- include('../layouts/footer') %>
